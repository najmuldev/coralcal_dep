{% extends "base_header.html" %}
{% load static %}
{% block head_title %}HerStory Plant Catalogue Form | CoralCal Doctor Engagement Platform{% endblock %}

{% block extra_css %}
<style>
  .thumbnail {
    transition: transform 0.3s ease, border-color 0.3s ease;
  }
  .thumbnail.selected {
    border: 2px solid #3b82f6;
    transform: scale(1.05);
  }
</style>
{% endblock extra_css %}

{% block content %}
<div class="bg-background p-8 rounded-md border border-border shadow-sm max-w-2xl mx-auto">
    <div class="card">
        <div>
            <div class="mb-6 flex justify-between gap-5 text-center ">
                <h2 class="text-sm sm:text-base md:text-lg font-bold text-primary text-center">
                    HerStory Plant Catalogue
                </h2>
                <div class="flex gap-2">
                    <a href="{% url 'p_history' %}" class="button button--sm button--primary"><i data-lucide="history"></i> History</a>
                    <a href="{% url 'home' %}" class="button button--sm button--primary"><i data-lucide="arrow-left"></i> Back</a>
                </div>
            </div>


            <div id="main-container" class="border border-border p-4 rounded-md">
                <div class="form-container">
                    <div class="form-header">
                        <form method="post" class="flex flex-col gap-6" enctype="multipart/form-data" onsubmit="return submitForm()">
                            {% csrf_token %}
                            <div class="form-item">
                                <label class="label" for="dr_id">Doctor RPL ID<span class="text-red-500">*</span></label>
                                <input 
                                    type="text"
                                    id="dr_id"
                                    name="dr_id"
                                    maxlength="10"
                                    class="input"
                                    required
                                    placeholder="Enter Doctor RPL ID"
                                />
                            </div>

                            <div class="form-item">
                                <label class="label" for="dr_name">Doctor Name<span class="text-red-500">*</span></label>
                                <input 
                                    type="text"
                                    id="dr_name"
                                    name="dr_name"
                                    maxlength="100"
                                    class="input"
                                    required
                                    placeholder="Enter Doctor Name"
                                />
                            </div>
                            <!-- Specialty -->
                            <div class="form-item">
                                <label class="label">Specialty <span class="text-red-500">*</span></label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                    <input type="radio" name="dr_specialty" value="Gynecologists" required
                                            {% if doctor.specialty == "Gynecologists" %}checked{% endif %}>
                                    <span>Gynecologists</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                    <input type="radio" name="dr_specialty" value="Orthopedics" required
                                            {% if doctor.specialty == "Orthopedics" %}checked{% endif %}>
                                    <span>Orthopedics</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                    <input type="radio" name="dr_specialty" value="Others" required
                                            {% if doctor.specialty == "Others" %}checked{% endif %}>
                                    <span>Others</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Designation -->
                            <div class="form-item">
                                <label class="label" for="dr_designation">Designation <span class="text-red-500">*</span></label>
                                <textarea id="dr_designation" name="dr_designation" maxlength="500" rows="2"
                                            class="input resize-none auto-expand" required
                                            placeholder="Enter Designation: Professor, Department of Surgery, DMC.">{{ doctor.designation|default:'' }}</textarea>
                                <div class="text-right text-xs mt-1 text-gray-500">
                                    <span id="designationCount">0</span>/500 characters
                                </div>
                            </div>

                            <div class="form-item">
                                <label class="label" for="location">Location<span class="text-red-500">*</span></label>
                                <input 
                                    type="text"
                                    id="location"
                                    name="location"
                                    maxlength="100"
                                    class="input"
                                    required
                                    placeholder="Enter Doctor Location"
                                />
                            </div>

                            <div class="form-item mb-4">
                                <label class="label" for="select_book">Select Plant(1 Items)<span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                    <div class="thumbnail cursor-pointer rounded-xl overflow-hidden border border-gray-300" data-name="Bonsai" data-type="flower" onclick="selectThumbnail(this)">
                                        <img src="{% static 'images/bonsai.jpeg' %}" alt="flower-1" class="object-cover w-full h-full">
                                        <p class="text-center text-xs text-gray-600 mt-2">Bonsai</p>
                                    </div>
                                    <div class="thumbnail cursor-pointer rounded-xl overflow-hidden border border-gray-300" data-name="Lucky Bamboo" data-type="flower" onclick="selectThumbnail(this)">
                                        <img src="{% static 'images/bamboo.jpeg' %}" alt="flower-2" class="object-cover w-full h-full">
                                        <p class="text-center text-xs text-gray-600 mt-2">Lucky Bamboo</p>
                                    </div>
                                    <div class="thumbnail cursor-pointer rounded-xl overflow-hidden border border-gray-300" data-name="Cactus" data-type="flower" onclick="selectThumbnail(this)">
                                        <img src="{% static 'images/cactus.jpeg' %}" alt="flower-3" class="object-cover w-full h-full">
                                        <p class="text-center text-xs text-gray-600 mt-2">Cactus</p>
                                    </div>
                            
                                </div>
                            </div>

                            
                            </div>

                            <!-- Hidden inputs for flower and medicinal plants -->
                            <input type="hidden" name="first_flower_plant" id="first_flower_plant">

                            <button type="submit" class="button button--md button--primary">
                                Submit
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full text-center">
        <p id="errorMessage" class="text-sm text-red-600 font-medium mb-4"></p>
        <button onclick="closeModal()" class="button button--sm button--primary">Close</button>
    </div>
</div>

<script>
    const selectedFlowers = [];

    function selectThumbnail(element) {
        const name = element.getAttribute('data-name');
        const type = element.getAttribute('data-type');
        const isSelected = element.classList.contains('selected');

        if (isSelected) {
            element.classList.remove('selected');
            if (type === 'flower') {
                const index = selectedFlowers.indexOf(name);
                if (index > -1) selectedFlowers.splice(index, 1);
            }
        } else {
            if (type === 'flower') {
                if (selectedFlowers.length >= 1) {
                    showModal("You can only select 1 plant.");
                    return;
                }
                selectedFlowers.push(name);
            } 
            element.classList.add('selected');
        }

        // Update hidden inputs
        document.getElementById('first_flower_plant').value = selectedFlowers[0] || "";
    }

    function submitForm() {
        const drId = document.getElementById('dr_id').value.trim();
        const drName = document.getElementById('dr_name').value.trim();

        if (!drId || !drName) {
            showModal('Please fill out all required fields.');
            return false;
        }

        if (selectedFlowers.length !== 1) {
            showModal('Please select exactly 1 plant.');
            return false;
        }

        return true;
    }

    function showModal(message) {
        document.getElementById('errorMessage').innerText = message;
        document.getElementById('errorModal').classList.remove('hidden');
        document.getElementById('errorModal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('errorModal').classList.add('hidden');
        document.getElementById('errorModal').classList.remove('flex');
    }

    function updateDesignationCounter() {
  const textarea = document.getElementById('dr_designation');
  const counter = document.getElementById('designationCount');
  if (textarea && counter) {
    counter.textContent = textarea.value.length;
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  }
}

// Initialize on load
window.addEventListener('DOMContentLoaded', () => {
  updateDesignationCounter();  // Set initial count & height
  if (typeof lucide !== 'undefined') lucide.createIcons();

  // Auto-expand + counter
  document.getElementById('dr_designation').addEventListener('input', updateDesignationCounter);
});
</script>
{% endblock %}
